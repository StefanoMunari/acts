defmodule BrokerToAs.Utils.DeepInspection.Tread do

  alias BrokerToAs.Utils.DeepInspection.Vehicle, as: DeepVehicle

  def generate_payload(mw_message) do
    mw_payload =
      mw_message.payload
      |> JSX.decode
      |> elem(1)

    traveller_id =
      mw_payload
      |> Map.get("Header")
      |> Map.get("Request_Id")
      |> to_int

    infra =
      mw_payload
      |> Map.get("Header")
      |> Map.get("Recipient")
      |> to_int

    traveller_type =
      mw_payload
        |> Map.get("Header")
        |> Map.get("Type")

    speed =
      mw_payload
      |> Map.get("Payload")
      |> Map.get("Current_Speed")
      |> to_int

    passengers =
      mw_payload
      |> DeepVehicle.extract_passengers
      |> Enum.map(fn passenger -> to_int(passenger) end)

    { :ok, new_payload } =
      JSX.encode (
        %{
          travellerId:      traveller_id,
          infrastructureId: infra,
          districtId:       mw_message.recipient,
          travellerType:    traveller_type,
          passengers:       passengers,
          speed:            speed,
          action:           "tread"
        }
      )

    %{mw_message | payload: new_payload}
  end

  def generate_topics(mw_message) do
    persistence =
      "persistence.#{mw_message.sender}"

    districts =
      [ "district.#{mw_message.sender}", "district.#{mw_message.recipient}" ]
      |> Enum.uniq

    mw_payload =
      mw_message.payload
      |> JSX.decode
      |> elem(1)

    travellers =
      [
        mw_payload
        |> Map.get("Header")
        |> Map.get("Request_Id")
      |
        DeepVehicle.extract_passengers mw_payload
      ]
      |> Enum.reject(fn traveller -> traveller == "" end)
      |> Enum.map(fn traveller -> "traveller.#{traveller}" end)

    [ persistence | districts ++ travellers ]
    |> List.flatten
    |> Enum.map(fn topic -> %{mw_message | topic: topic} end)
  end

  defp to_int(n)
  when is_integer n do
    n
  end
  defp to_int(n)
  when is_binary n do
    String.to_integer n
  end
  defp to_int(_), do: ""
end

# "{\"async\":true,\"payload\":\"{\\\"Header\\\":{\\\"Call\\\":\\\"ASYNC\\\",\\\"Recipient\\\":\\\"135\\\",\\\"Recipient_Type\\\":\\\"TREADABLE\\\",\\\"Request\\\":\\\"TREAD\\\",\\\"Request_Id\\\":\\\"2\\\",\\\"Type\\\":\\\"BUS\\\"},\\\"Payload\\\":{\\\"Current_Position\\\":\\\"135\\\",\\\"Current_Speed\\\":\\\"80\\\",\\\"Destination_BIKE\\\":\\\"\\\",\\\"Destination_FOOT\\\":\\\"\\\",\\\"Destination_ROAD\\\":\\\"\\\",\\\"Id\\\":\\\"2\\\",\\\"Max_Passengers\\\":\\\"6\\\",\\\"Maximum_Speed\\\":\\\"80\\\",\\\"Passengers\\\":\\\"666\\\",\\\"Source_BIKE\\\":\\\"\\\",\\\"Source_FOOT\\\":\\\"\\\",\\\"Source_ROAD\\\":\\\"\\\",\\\"busStops\\\":\\\"24,23,17,8,29,9,13,28,27,26\\\",\\\"routeStops\\\":\\\"130,763,835,344,829,415,692,762,834,766\\\",\\\"Route\\\":[\\\"409,\\\",\\\"410,\\\",\\\"411,\\\",\\\"412,\\\",\\\"413,\\\",\\\"414,\\\",\\\"415,\\\",\\\"759,\\\",\\\"760,\\\",\\\"761,\\\",\\\"762,\\\",\\\"763,\\\",\\\"763,\\\",\\\"764,\\\",\\\"765,\\\",\\\"829,\\\",\\\"830,\\\",\\\"831,\\\",\\\"832,\\\",\\\"833,\\\",\\\"834,\\\",\\\"835,\\\",\\\"835,\\\",\\\"696,\\\",\\\"697,\\\",\\\"698,\\\",\\\"699,\\\",\\\"700,\\\",\\\"701,\\\",\\\"702,\\\",\\\"626,\\\",\\\"627,\\\",\\\"628,\\\",\\\"629,\\\",\\\"630,\\\",\\\"631,\\\",\\\"632,\\\",\\\"276,\\\",\\\"277,\\\",\\\"278,\\\",\\\"279,\\\",\\\"280,\\\",\\\"281,\\\",\\\"282,\\\",\\\"199,\\\",\\\"200,\\\",\\\"201,\\\",\\\"202,\\\",\\\"203,\\\",\\\"204,\\\",\\\"205,\\\",\\\"339,\\\",\\\"340,\\\",\\\"341,\\\",\\\"342,\\\",\\\"343,\\\",\\\"344,\\\",\\\"344,\\\",\\\"345,\\\",\\\"626,\\\",\\\"627,\\\",\\\"628,\\\",\\\"629,\\\",\\\"630,\\\",\\\"631,\\\",\\\"632,\\\",\\\"549,\\\",\\\"550,\\\",\\\"551,\\\",\\\"552,\\\",\\\"553,\\\",\\\"554,\\\",\\\"555,\\\",\\\"829,\\\",\\\"829,\\\",\\\"830,\\\",\\\"831,\\\",\\\"832,\\\",\\\"833,\\\",\\\"834,\\\",\\\"835,\\\",\\\"696,\\\",\\\"697,\\\",\\\"698,\\\",\\\"699,\\\",\\\"700,\\\",\\\"701,\\\",\\\"702,\\\",\\\"626,\\\",\\\"627,\\\",\\\"628,\\\",\\\"629,\\\",\\\"630,\\\",\\\"631,\\\",\\\"632,\\\",\\\"486,\\\",\\\"487,\\\",\\\"488,\\\",\\\"489,\\\",\\\"490,\\\",\\\"491,\\\",\\\"492,\\\",\\\"409,\\\",\\\"410,\\\",\\\"411,\\\",\\\"412,\\\",\\\"413,\\\",\\\"414,\\\",\\\"415,\\\",\\\"415,\\\",\\\"759,\\\",\\\"760,\\\",\\\"761,\\\",\\\"762,\\\",\\\"763,\\\",\\\"764,\\\",\\\"765,\\\",\\\"556,\\\",\\\"557,\\\",\\\"558,\\\",\\\"559,\\\",\\\"560,\\\",\\\"561,\\\",\\\"562,\\\",\\\"619,\\\",\\\"620,\\\",\\\"621,\\\",\\\"622,\\\",\\\"623,\\\",\\\"624,\\\",\\\"625,\\\",\\\"689,\\\",\\\"690,\\\",\\\"691,\\\",\\\"692,\\\",\\\"692,\\\",\\\"693,\\\",\\\"694,\\\",\\\"695,\\\",\\\"836,\\\",\\\"837,\\\",\\\"838,\\\",\\\"839,\\\",\\\"840,\\\",\\\"841,\\\",\\\"842,\\\",\\\"556,\\\",\\\"557,\\\",\\\"558,\\\",\\\"559,\\\",\\\"560,\\\",\\\"561,\\\",\\\"562,\\\",\\\"486,\\\",\\\"487,\\\",\\\"488,\\\",\\\"489,\\\",\\\"490,\\\",\\\"491,\\\",\\\"492,\\\",\\\"409,\\\",\\\"410,\\\",\\\"411,\\\",\\\"412,\\\",\\\"413,\\\",\\\"414,\\\",\\\"415,\\\",\\\"759,\\\",\\\"760,\\\",\\\"761,\\\",\\\"762,\\\",\\\"762,\\\",\\\"763,\\\",\\\"764,\\\",\\\"765,\\\",\\\"829,\\\",\\\"830,\\\",\\\"831,\\\",\\\"832,\\\",\\\"833,\\\",\\\"834,\\\",\\\"834,\\\",\\\"835,\\\",\\\"696,\\\",\\\"697,\\\",\\\"698,\\\",\\\"699,\\\",\\\"700,\\\",\\\"701,\\\",\\\"702,\\\",\\\"626,\\\",\\\"627,\\\",\\\"628,\\\",\\\"629,\\\",\\\"630,\\\",\\\"631,\\\",\\\"632,\\\",\\\"549,\\\",\\\"550,\\\",\\\"551,\\\",\\\"552,\\\",\\\"553,\\\",\\\"554,\\\",\\\"555,\\\",\\\"766,\\\",\\\"766,\\\",\\\"767,\\\",\\\"768,\\\",\\\"769,\\\",\\\"770,\\\",\\\"771,\\\",\\\"772,\\\",\\\"416,\\\",\\\"417,\\\",\\\"418,\\\",\\\"419,\\\",\\\"420,\\\",\\\"421,\\\",\\\"422,\\\",\\\"479,\\\",\\\"480,\\\",\\\"481,\\\",\\\"482,\\\",\\\"483,\\\",\\\"484,\\\",\\\"485,\\\",\\\"276,\\\",\\\"277,\\\",\\\"278,\\\",\\\"279,\\\",\\\"280,\\\",\\\"281,\\\",\\\"282,\\\",\\\"66,\\\",\\\"67,\\\",\\\"68,\\\",\\\"69,\\\",\\\"70,\\\",\\\"71,\\\",\\\"72,\\\",\\\"129,\\\",\\\"130,\\\",\\\"130,\\\",\\\"131,\\\",\\\"132,\\\",\\\"133,\\\",\\\"134,\\\",\\\"135,\\\"]}}\",\"recipient\":\"0\",\"sender\":\"0\",\"topic\":\"application.tread.0.2\"}"
